name: Update PKGBUILD

on:
  workflow_run:
    workflows: ['Release']
    types: [completed]

permissions:
  contents: write

jobs:
  update-pkgbuild:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.event == 'push' }}
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          ref: main
          fetch-depth: 0

      - name: Extract version from tag
        id: version
        run: |
          # Get the tag that triggered the release workflow
          git fetch --tags
          # Extract tag from the workflow run that triggered this
          TAG=$(git describe --tags --exact-match ${{ github.event.workflow_run.head_sha }} 2>/dev/null || echo "")

          # Fallback to latest tag if exact match not found
          if [ -z "$TAG" ]; then
            echo "Warning: Could not find exact tag for commit, using latest tag"
            TAG=$(git tag --sort=-v:refname | head -n1)
          fi

          VERSION=${TAG#v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "Found version: $VERSION (tag: $TAG)"

      - name: Update PKGBUILD files
        run: |
          sed -i "s/^pkgver=.*/pkgver=${{ steps.version.outputs.version }}/" PKGBUILD
          sed -i "s/^pkgver=.*/pkgver=${{ steps.version.outputs.version }}/" PKGBUILD-bin
          sed -i "s/^pkgrel=.*/pkgrel=1/" PKGBUILD
          sed -i "s/^pkgrel=.*/pkgrel=1/" PKGBUILD-bin

      - name: Download release tarball and update checksums
        run: |
          # Wait a bit for release assets to be fully available
          sleep 10

          # Download the Linux x86_64 tarball with retry
          for i in {1..5}; do
            if wget -q https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.tag }}/clean-history-linux-x86_64.tar.gz; then
              break
            fi
            echo "Download attempt $i failed, retrying..."
            sleep 5
          done

          if [ ! -f clean-history-linux-x86_64.tar.gz ]; then
            echo "Error: Failed to download release tarball"
            exit 1
          fi

          # Calculate SHA256
          SHA256=$(sha256sum clean-history-linux-x86_64.tar.gz | awk '{print $1}')
          echo "Calculated SHA256: $SHA256"

          # Update PKGBUILD-bin with real checksum
          sed -i "s/^sha256sums=.*/sha256sums=('$SHA256')/" PKGBUILD-bin

      - name: Commit and push changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add PKGBUILD PKGBUILD-bin
          git commit -m "chore: update PKGBUILD to v${{ steps.version.outputs.version }}"
          git push

      - name: Update AUR package
        env:
          AUR_SSH_PRIVATE_KEY: ${{ secrets.AUR_SSH_PRIVATE_KEY }}
        run: |
          if [ -z "$AUR_SSH_PRIVATE_KEY" ]; then
            echo "Skipping AUR update: AUR_SSH_PRIVATE_KEY not set"
            exit 0
          fi
          chmod +x ./.github/scripts/update-aur.sh
          ./.github/scripts/update-aur.sh clean-history-bin PKGBUILD-bin ${{ steps.version.outputs.version }}
